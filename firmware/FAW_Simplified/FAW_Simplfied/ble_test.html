<!DOCTYPE html>
<html>
<head>
    <title>FAW Trap Monitor v3</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: #1a1a2e; color: #eee; padding: 20px; max-width: 900px; margin: 0 auto; min-height: 100vh; }
        h1 { color: #00ff88; text-align: center; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #888; margin-bottom: 20px; font-size: 14px; }
        
        .status { text-align: center; padding: 12px; border-radius: 8px; margin: 10px 0; font-weight: bold; }
        .disconnected { background: #ff4444; }
        .connected { background: #00aa55; }
        .connecting { background: #ffaa00; color: #000; }
        
        button { padding: 12px 24px; margin: 5px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        button:active { transform: scale(0.95); }
        .btn-connect { background: #00ff88; color: #000; }
        .btn-connect:hover { background: #00dd66; }
        .btn-action { background: #4488ff; color: #fff; }
        .btn-action:hover { background: #3366dd; }
        .btn-action:disabled { background: #555; cursor: not-allowed; }
        .btn-danger { background: #ff4466; color: #fff; }
        .btn-danger:hover { background: #dd3355; }
        .btn-download { background: #ff8800; color: #fff; }
        .btn-download:hover { background: #dd7700; }
        .btn-fetch { background: #aa44ff; color: #fff; }
        .btn-fetch:hover { background: #8833dd; }
        
        .button-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 15px 0; }
        
        .card { background: #0d0d1a; border: 2px solid #333; border-radius: 12px; padding: 20px; margin: 15px 0; }
        .card h3 { color: #00ff88; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .card h3 .badge { background: #4488ff; color: #fff; padding: 4px 10px; border-radius: 12px; font-size: 12px; }
        .card h3 .badge.device { background: #aa44ff; }
        .card h3 .badge.sd { background: #00aa55; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; }
        .stat { text-align: center; padding: 15px 10px; background: #1a1a2e; border-radius: 8px; }
        .stat-value { font-size: 24px; font-weight: bold; color: #00ff88; }
        .stat-value.highlight { color: #ff8800; font-size: 32px; }
        .stat-value.purple { color: #aa44ff; }
        .stat-label { font-size: 10px; color: #888; margin-top: 5px; text-transform: uppercase; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { border: 1px solid #333; padding: 8px; text-align: left; }
        th { background: #2a2a4e; color: #00ff88; position: sticky; top: 0; }
        tr:nth-child(even) { background: #0d0d1a; }
        tr:hover { background: #2a2a3e; }
        .table-container { max-height: 350px; overflow-y: auto; border-radius: 8px; }
        
        .last-update { text-align: center; color: #666; font-size: 12px; margin-top: 10px; }
        .device-info { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; font-size: 13px; color: #888; margin-top: 15px; }
        .device-info .tag { background: #333; padding: 3px 8px; border-radius: 4px; }
        .device-info .tag.green { background: #00aa55; color: #fff; }
        .device-info .tag.red { background: #aa3333; color: #fff; }
        
        #log { background: #000; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 11px; max-height: 120px; overflow-y: auto; color: #0f0; }
        
        .progress-bar { width: 100%; height: 20px; background: #333; border-radius: 10px; overflow: hidden; margin: 10px 0; display: none; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #00ff88, #00aa55); transition: width 0.3s; }
        .progress-text { text-align: center; font-size: 12px; color: #888; }
        
        .moth-alert { animation: pulse 0.5s ease-in-out 3; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .empty-state { text-align: center; color: #666; padding: 40px; }
        .empty-state .icon { font-size: 48px; margin-bottom: 10px; }
        
        .source-toggle { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .source-toggle button { padding: 8px 16px; font-size: 12px; }
        .source-toggle button.active { background: #00ff88; color: #000; }
    </style>
</head>
<body>
    <h1>ü¶ã FAW Trap Monitor</h1>
    <p class="subtitle">Fall Armyworm Moth Detection System v3</p>
    
    <div id="status" class="status disconnected">Disconnected</div>
    
    <div class="button-row">
        <button id="connectBtn" class="btn-connect" onclick="connect()">üîó Connect to Trap</button>
    </div>
    
    <!-- Live Data Card -->
    <div class="card">
        <h3>üìä Live Data</h3>
        <div class="stats">
            <div class="stat">
                <div class="stat-value highlight" id="mothCount">--</div>
                <div class="stat-label">Total Moths</div>
            </div>
            <div class="stat">
                <div class="stat-value purple" id="recordCount">--</div>
                <div class="stat-label">NVS Records</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="airTemp">--</div>
                <div class="stat-label">Air ¬∞C</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="humidity">--</div>
                <div class="stat-label">Humidity %</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="soilTemp">--</div>
                <div class="stat-label">Soil ¬∞C</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="deviceTime">--</div>
                <div class="stat-label">Device Time</div>
            </div>
        </div>
        <div class="last-update">Last update: <span id="lastUpdate">Never</span></div>
        <div class="device-info">
            <span>Device: <strong id="deviceName">--</strong></span>
            <span>Firmware: <strong id="firmware">--</strong></span>
            <span>Last Moth: <strong id="lastMoth">--</strong></span>
            <span>Night Mode: <span id="nightMode" class="tag">--</span></span>
            <span>SD Card: <span id="sdStatus" class="tag">--</span></span>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="button-row">
        <button id="refreshBtn" class="btn-action" onclick="getData()" disabled>üîÑ Refresh</button>
        <button id="fetchBtn" class="btn-fetch" onclick="fetchDeviceLog()" disabled>üì• Fetch Device Records</button>
        <button id="downloadBtn" class="btn-download" onclick="downloadCSV()">üíæ Download CSV</button>
        <button id="resetBtn" class="btn-danger" onclick="resetTrap()" disabled>üóëÔ∏è Reset Device</button>
    </div>
    
    <!-- Progress Bar -->
    <div id="progressContainer">
        <div class="progress-bar" id="progressBar">
            <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="progress-text" id="progressText"></div>
    </div>
    
    <!-- Moth Records Card -->
    <div class="card">
        <h3>
            üìã Moth Detection Records
            <span class="badge" id="recordBadge">0 records</span>
        </h3>
        
        <div class="source-toggle">
            <button id="srcDevice" class="btn-action active" onclick="setSource('device')">üì° Device Records</button>
            <button id="srcSession" class="btn-action" onclick="setSource('session')">üíª Session Records</button>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Time</th>
                        <th>Air ¬∞C</th>
                        <th>Humidity %</th>
                        <th>Soil ¬∞C</th>
                    </tr>
                </thead>
                <tbody id="recordsBody">
                    <tr><td colspan="5" class="empty-state">
                        <div class="icon">üì°</div>
                        Connect and fetch records from device
                    </td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Connection Log -->
    <div class="card">
        <h3>üì° Connection Log</h3>
        <div id="log">Ready to connect...\nUse Chrome browser for Bluetooth support.</div>
    </div>

    <script>
        // ============================================================
        // BLE Configuration
        // ============================================================
        
        const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
        const TX_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
        const RX_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a9';
        
        // ============================================================
        // State
        // ============================================================
        
        let device = null;
        let rxChar = null;
        let connected = false;
        
        // Records from device (fetched via GET_LOG)
        let deviceRecords = [];
        
        // Records from current session (tracked while connected)
        let sessionRecords = [];
        
        // Which records to display
        let currentSource = 'device';
        
        // For tracking new moths while connected
        let lastMothCount = null;
        let currentEnvData = {};
        
        // Log transfer state
        let logTransferInProgress = false;
        let expectedLogCount = 0;
        let receivedLogs = [];
        
        // Auto-refresh interval
        let autoRefreshInterval = null;
        
        // ============================================================
        // Initialization
        // ============================================================
        
        // Load session records from localStorage
        const savedSession = localStorage.getItem('faw_session_records_v3');
        if (savedSession) {
            sessionRecords = JSON.parse(savedSession);
        }
        
        // Load device records from localStorage (cache)
        const savedDevice = localStorage.getItem('faw_device_records_v3');
        if (savedDevice) {
            deviceRecords = JSON.parse(savedDevice);
            updateRecordsTable();
        }
        
        // ============================================================
        // Logging
        // ============================================================
        
        function log(msg) {
            const el = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            el.textContent = `[${time}] ${msg}\n` + el.textContent;
            if (el.textContent.length > 5000) {
                el.textContent = el.textContent.slice(0, 4000);
            }
            console.log(`[${time}] ${msg}`);
        }
        
        // ============================================================
        // UI Helpers
        // ============================================================
        
        function setStatus(text, className) {
            const el = document.getElementById('status');
            el.textContent = text;
            el.className = 'status ' + className;
        }
        
        function setButtons(enabled) {
            document.getElementById('refreshBtn').disabled = !enabled;
            document.getElementById('fetchBtn').disabled = !enabled;
            document.getElementById('resetBtn').disabled = !enabled;
        }
        
        function showProgress(show, percent = 0, text = '') {
            document.getElementById('progressBar').style.display = show ? 'block' : 'none';
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }
        
        function setSource(source) {
            currentSource = source;
            document.getElementById('srcDevice').classList.toggle('active', source === 'device');
            document.getElementById('srcSession').classList.toggle('active', source === 'session');
            updateRecordsTable();
        }
        
        // ============================================================
        // BLE Connection
        // ============================================================
        
        async function connect() {
            try {
                setStatus('Scanning...', 'connecting');
                log('Scanning for FAWTrap devices...');
                
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'FAWTrap' }],
                    optionalServices: [SERVICE_UUID]
                });
                
                log('Found: ' + device.name);
                device.addEventListener('gattserverdisconnected', onDisconnected);
                
                setStatus('Connecting...', 'connecting');
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                
                // Subscribe to notifications
                const txChar = await service.getCharacteristic(TX_UUID);
                await txChar.startNotifications();
                txChar.addEventListener('characteristicvaluechanged', onData);
                
                // Get write characteristic
                rxChar = await service.getCharacteristic(RX_UUID);
                
                connected = true;
                setStatus('Connected: ' + device.name, 'connected');
                setButtons(true);
                document.getElementById('connectBtn').textContent = 'üîå Disconnect';
                document.getElementById('connectBtn').onclick = disconnect;
                
                log('Connected!');
                
                // Get initial data
                getData();
                
                // Auto-refresh every 30 seconds
                autoRefreshInterval = setInterval(() => {
                    if (connected && !logTransferInProgress) getData();
                }, 30000);
                
            } catch (e) {
                log('Error: ' + e.message);
                setStatus('Connection failed', 'disconnected');
                console.error(e);
            }
        }
        
        function disconnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
        }
        
        function onDisconnected() {
            connected = false;
            logTransferInProgress = false;
            setStatus('Disconnected', 'disconnected');
            setButtons(false);
            document.getElementById('connectBtn').textContent = 'üîó Connect to Trap';
            document.getElementById('connectBtn').onclick = connect;
            log('Disconnected');
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            
            showProgress(false);
        }
        
        // ============================================================
        // BLE Data Handling
        // ============================================================
        
        function onData(event) {
            const decoder = new TextDecoder('utf-8');
            const text = decoder.decode(event.target.value);
            
            console.log('Received:', text);
            
            if (text.startsWith('DATA:')) {
                parseData(text);
            } else if (text.startsWith('MOTH:')) {
                handleMothNotification(text);
            } else if (text.startsWith('LOG_START:')) {
                handleLogStart(text);
            } else if (text.startsWith('LOG:')) {
                handleLogEntry(text);
            } else if (text === 'LOG_END') {
                handleLogEnd();
            } else if (text === 'LOG:EMPTY') {
                handleLogEmpty();
            } else if (text.startsWith('RESET:')) {
                log('Device reset confirmed');
                lastMothCount = 0;
                deviceRecords = [];
                localStorage.setItem('faw_device_records_v3', JSON.stringify(deviceRecords));
                updateRecordsTable();
            }
        }
        
        function parseData(raw) {
            const data = raw.replace('DATA:', '');
            const pairs = data.split(',');
            const values = {};
            
            pairs.forEach(pair => {
                const idx = pair.indexOf('=');
                if (idx > 0) {
                    const key = pair.substring(0, idx).trim();
                    const val = pair.substring(idx + 1).trim();
                    values[key] = val;
                }
            });
            
            console.log('Parsed:', values);
            currentEnvData = values;
            
            // Update UI
            if (values.moths !== undefined) {
                document.getElementById('mothCount').textContent = values.moths;
                
                // Check for new moths
                const currentMoths = parseInt(values.moths) || 0;
                if (lastMothCount !== null && currentMoths > lastMothCount) {
                    const newMoths = currentMoths - lastMothCount;
                    log('ü¶ã ' + newMoths + ' new moth(s)!');
                    
                    // Animate
                    const el = document.getElementById('mothCount');
                    el.classList.add('moth-alert');
                    setTimeout(() => el.classList.remove('moth-alert'), 1500);
                    
                    // Add to session records
                    for (let i = 0; i < newMoths; i++) {
                        addSessionRecord(lastMothCount + i + 1, values);
                    }
                }
                lastMothCount = currentMoths;
            }
            
            if (values.records !== undefined) document.getElementById('recordCount').textContent = values.records;
            if (values.airTemp !== undefined) document.getElementById('airTemp').textContent = values.airTemp;
            if (values.humidity !== undefined) document.getElementById('humidity').textContent = values.humidity;
            if (values.soilTemp !== undefined) document.getElementById('soilTemp').textContent = values.soilTemp;
            if (values.time !== undefined) document.getElementById('deviceTime').textContent = values.time;
            if (values.device) document.getElementById('deviceName').textContent = values.device;
            if (values.version) document.getElementById('firmware').textContent = 'v' + values.version;
            if (values.lastMoth) document.getElementById('lastMoth').textContent = values.lastMoth;
            
            // Night mode indicator
            const nightEl = document.getElementById('nightMode');
            if (values.night === '1') {
                nightEl.textContent = 'ON';
                nightEl.className = 'tag green';
            } else {
                nightEl.textContent = 'OFF';
                nightEl.className = 'tag';
            }
            
            // SD card indicator
            const sdEl = document.getElementById('sdStatus');
            if (values.sd === '1') {
                sdEl.textContent = 'OK';
                sdEl.className = 'tag green';
            } else {
                sdEl.textContent = 'NO';
                sdEl.className = 'tag red';
            }
            
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
        }
        
        function handleMothNotification(text) {
            log('ü¶ã MOTH DETECTED!');
            const el = document.getElementById('mothCount');
            el.classList.add('moth-alert');
            setTimeout(() => el.classList.remove('moth-alert'), 1500);
            
            // Refresh data
            setTimeout(() => getData(), 500);
        }
        
        // ============================================================
        // Log Transfer
        // ============================================================
        
        function handleLogStart(text) {
            const count = parseInt(text.split(':')[1]) || 0;
            expectedLogCount = count;
            receivedLogs = [];
            logTransferInProgress = true;
            
            log('Receiving ' + count + ' records...');
            showProgress(true, 0, 'Fetching records: 0/' + count);
        }
        
        function handleLogEntry(text) {
            if (!logTransferInProgress) return;
            
            // LOG:id,time,airT,hum,soilT (5 fields in v1.3)
            const data = text.replace('LOG:', '');
            const parts = data.split(',');
            
            console.log('Log entry parts:', parts);
            
            if (parts.length >= 5) {
                const record = {
                    id: parseInt(parts[0]) || 0,
                    time: parts[1],
                    airTemp: parts[2],
                    humidity: parts[3],
                    soilTemp: parts[4]
                };
                receivedLogs.push(record);
                
                const percent = Math.round((receivedLogs.length / expectedLogCount) * 100);
                showProgress(true, percent, `Fetching records: ${receivedLogs.length}/${expectedLogCount}`);
            }
        }
        
        function handleLogEnd() {
            logTransferInProgress = false;
            
            // Sort by ID (newest first)
            receivedLogs.sort((a, b) => b.id - a.id);
            
            deviceRecords = receivedLogs;
            localStorage.setItem('faw_device_records_v3', JSON.stringify(deviceRecords));
            
            log('Received ' + deviceRecords.length + ' records from device');
            showProgress(false);
            
            setSource('device');
            updateRecordsTable();
        }
        
        function handleLogEmpty() {
            logTransferInProgress = false;
            deviceRecords = [];
            localStorage.setItem('faw_device_records_v3', JSON.stringify(deviceRecords));
            log('Device has no stored records');
            showProgress(false);
            updateRecordsTable();
        }
        
        // ============================================================
        // Session Records (tracked while connected)
        // ============================================================
        
        function addSessionRecord(mothId, envData) {
            const record = {
                id: mothId,
                time: new Date().toLocaleString(),
                airTemp: envData.airTemp || '--',
                humidity: envData.humidity || '--',
                soilTemp: envData.soilTemp || '--'
            };
            
            sessionRecords.unshift(record);
            
            // Keep max 500
            if (sessionRecords.length > 500) {
                sessionRecords = sessionRecords.slice(0, 500);
            }
            
            localStorage.setItem('faw_session_records_v3', JSON.stringify(sessionRecords));
            
            if (currentSource === 'session') {
                updateRecordsTable();
            }
        }
        
        // ============================================================
        // Records Table
        // ============================================================
        
        function updateRecordsTable() {
            const records = currentSource === 'device' ? deviceRecords : sessionRecords;
            const tbody = document.getElementById('recordsBody');
            const badge = document.getElementById('recordBadge');
            
            badge.textContent = records.length + ' records';
            badge.className = 'badge' + (currentSource === 'device' ? ' device' : '');
            
            if (records.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="empty-state">
                    <div class="icon">${currentSource === 'device' ? 'üì°' : 'üíª'}</div>
                    ${currentSource === 'device' 
                        ? 'No device records. Click "Fetch Device Records" to download.' 
                        : 'No moths detected this session.'}
                </td></tr>`;
                return;
            }
            
            tbody.innerHTML = records.map(r => `
                <tr>
                    <td><strong>${r.id}</strong></td>
                    <td>${r.time}</td>
                    <td>${r.airTemp}</td>
                    <td>${r.humidity}%</td>
                    <td>${r.soilTemp}</td>
                </tr>
            `).join('');
        }
        
        // ============================================================
        // BLE Commands
        // ============================================================
        
        async function sendCommand(cmd) {
            if (!rxChar) return;
            try {
                const encoder = new TextEncoder();
                await rxChar.writeValue(encoder.encode(cmd));
            } catch (e) {
                log('Error: ' + e.message);
            }
        }
        
        async function getData() {
            log('Refreshing data...');
            await sendCommand('GET_DATA');
        }
        
        async function fetchDeviceLog() {
            if (logTransferInProgress) {
                log('Transfer already in progress');
                return;
            }
            
            log('Fetching records from device...');
            showProgress(true, 0, 'Starting transfer...');
            await sendCommand('GET_LOG');
        }
        
        async function resetTrap() {
            if (!confirm('Reset moth count and all records on the device?\n\nThis cannot be undone!')) {
                return;
            }
            
            log('Resetting device...');
            await sendCommand('RESET');
        }
        
        // ============================================================
        // CSV Download
        // ============================================================
        
        function downloadCSV() {
            const records = currentSource === 'device' ? deviceRecords : sessionRecords;
            const sourceName = currentSource === 'device' ? 'device' : 'session';
            
            if (records.length === 0) {
                alert('No records to download.\n\nFetch records from device or wait for moths to be detected.');
                return;
            }
            
            const headers = ['Moth_ID', 'Detection_Time', 'Air_Temp_C', 'Humidity_%', 'Soil_Temp_C'];
            let csv = headers.join(',') + '\n';
            
            records.forEach(r => {
                csv += `${r.id},"${r.time}",${r.airTemp},${r.humidity},${r.soilTemp}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `faw_trap_${sourceName}_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('Downloaded ' + records.length + ' records as CSV');
        }
    </script>
</body>
</html>